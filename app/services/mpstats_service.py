# app/services/mpstats_service.py
import aiohttp
import asyncio
from typing import List, Dict, Any
import logging
from app.config.config import config


class MPStatsService:
    """Сервис для работы с MPStats API"""

    def __init__(self):
        self.base_url = config.api.mpstats_base_url
        self.api_key = config.api.mpstats_key
        self.delay = config.api.mpstats_delay
        self.timeout = config.api.mpstats_timeout
        self.logger = logging.getLogger(__name__)
        self.session = None

    async def get_session(self):
        """Получить или создать aiohttp сессию"""
        if self.session is None:
            self.session = aiohttp.ClientSession(
                headers={
                    'X-MpStats-TOKEN': self.api_key,
                    'Content-Type': 'application/json'
                },
                timeout=aiohttp.ClientTimeout(total=self.timeout)
            )
        return self.session

    async def get_keywords_by_category(self, category_name: str, purpose: str) -> List[str]:
        """Получить ключевые слова по категории и назначению"""
        try:
            session = await self.get_session()

            # Имитация запроса к MPStats (заглушка)
            # В реальности здесь будет API запрос к MPStats
            await asyncio.sleep(self.delay)  # Имитация задержки

            # Заглушка - возвращаем тестовые данные
            keywords = await self._get_mock_keywords(category_name, purpose)

            self.logger.info(f"✅ Получено {len(keywords)} ключевых слов для категории '{category_name}'")
            return keywords

        except Exception as e:
            self.logger.error(f"❌ Ошибка получения ключевых слов из MPStats: {e}")
            return []

    # app/services/mpstats_service.py (обновляем mock данные)
    async def _get_mock_keywords(self, category: str, purpose: str) -> List[str]:
        """Заглушка для получения ключевых слов с реалистичными данными"""

        # Реалистичные ключевые слова для разных категорий и назначений
        mock_data = {
            "electronics": {
                "gaming": [
                    "игровой смартфон", "высокая производительность", "gaming phone", "мощный процессор",
                    "игры без лагов", "высокий FPS", "система охлаждения", "игровой режим",
                    "антибликовое покрытие", "быстрый отклик", "оптимизация для игр", "игровая графика",
                    "емкий аккумулятор", "игры на максималках", "гейминг", "производительность"
                ],
                "everyday": [
                    "смартфон", "качественная камера", "долгая батарея", "надежный", "удобный",
                    "компактный", "стильный дизайн", "ежедневное использование", "универсальный",
                    "практичный", "доступный", "популярная модель", "баланс цена-качество"
                ],
                "business": [
                    "бизнес смартфон", "безопасность данных", "двойная SIM-карта", "производительность",
                    "надежность", "премиальный дизайн", "долгая работа от батареи", "защита информации",
                    "корпоративное использование", "элегантный", "функциональный", "для переговоров"
                ],
                "creative": [
                    "профессиональная камера", "высокое разрешение", "цветопередача", "креативные возможности",
                    "видеосъемка", "фотография", "редактирование", "графический дизайн", "творчество",
                    "качественный дисплей", "точные цвета", "широкий динамический диапазон"
                ]
            },
            "clothing": {
                "sport": [
                    "спортивная одежда", "дыхательные материалы", "комфорт при тренировках", "эластичная ткань",
                    "влагопоглощение", "спортивный костюм", "тренировочная форма", "фитнес одежда",
                    "активный отдых", "функциональность", "свобода движений", "легкость"
                ],
                "casual": [
                    "повседневная одежда", "комфортный крой", "универсальный стиль", "качественные материалы",
                    "удобная", "практичная", "модная", "трендовая", "для ежедневной носки", "сочетаемость",
                    "базовый гардероб", "стильная"
                ],
                "office": [
                    "офисный стиль", "деловая одежда", "классический крой", "строгий стиль",
                    "бизнес дресс код", "формальная одежда", "качественные материалы", "элегантный вид",
                    "профессиональный образ", "презентабельный", "солидный", "для работы"
                ],
                "evening": [
                    "вечерний наряд", "элегантный", "гламурный", "праздничный", "торжественный",
                    "шикарный", "роскошный", "изысканный", "для особого случая", "выход в свет",
                    "блестящий", "притягательный"
                ]
            },
            "home": {
                "kitchen": [
                    "кухонные принадлежности", "практичность", "легкость ухода", "функциональность",
                    "качественные материалы", "долговечность", "эргономичный дизайн", "безопасность",
                    "современный дизайн", "удобство использования", "кухонная утварь", "аксессуары для кухни"
                ],
                "bedroom": [
                    "для спальни", "комфорт", "уют", "расслабляющая атмосфера", "качественные ткани",
                    "гармоничный дизайн", "функциональность", "организация пространства", "релаксация",
                    "здоровый сон", "эстетика", "гармония"
                ],
                "garden": [
                    "садовые принадлежности", "уличное использование", "погодоустойчивость", "долговечность",
                    "функциональность", "практичность", "ландшафтный дизайн", "садовая мебель",
                    "уход за растениями", "открытое пространство", "природные материалы"
                ],
                "bathroom": [
                    "для ванной комнаты", "влагостойкость", "гигиена", "функциональность",
                    "компактность", "легкость уборки", "качественные материалы", "эргономика",
                    "организация пространства", "чистота", "свежесть"
                ]
            },
            "beauty": {
                "skincare": [
                    "уход за кожей", "питание", "увлажнение", "омоложение", "очищение",
                    "натуральные компоненты", "гипоаллергенный", "эффективность", "результат",
                    "здоровая кожа", "сияние", "ухоженность"
                ],
                "makeup": [
                    "косметика", "макияж", "стойкость", "насыщенность цвета", "качественная текстура",
                    "легкость нанесения", "естественный вид", "профессиональный результат",
                    "разнообразие оттенков", "визаж", "красота"
                ],
                "hair": [
                    "уход за волосами", "восстановление", "блеск", "сила волос", "объем",
                    "легкость расчесывания", "защита от повреждений", "здоровый вид",
                    "натуральные компоненты", "профессиональный уход", "красота волос"
                ],
                "wellness": [
                    "здоровье", "благополучие", "релаксация", "оздоровление", "натуральность",
                    "эффективность", "безопасность", "гармония", "энергия", "витамины",
                    "минералы", "польза для организма"
                ]
            }
        }

        category_keywords = mock_data.get(category, {})
        return category_keywords.get(purpose, ["качественный", "популярный", purpose])

    async def close(self):
        """Закрыть сессию"""
        if self.session:
            await self.session.close()

    async def __aenter__(self):
        return self

    async def __aexit__(self, exc_type, exc_val, exc_tb):
        await self.close()