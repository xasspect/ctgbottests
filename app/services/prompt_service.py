# app/services/prompt_service.py
import logging
from typing import List, Optional


class PromptService:
    """Сервис для управления промптами для нейросетей"""

    def __init__(self):
        self.logger = logging.getLogger(__name__)

    def get_keywords_filter_prompt(
            self,
            category: str,
            purposes: List[str],
            additional_params: List[str],
            category_description: str = "",
            max_keywords: int = 10
    ) -> tuple[str, str]:
        """
        Промпт для фильтрации ключевых слов через GPT

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if isinstance(purposes, list) else str(purposes)
        params_text = ", ".join(additional_params) if additional_params else "не указаны"

        system_prompt = f"""Ты — профессиональный маркетолог-копирайтер для маркетплейсов Wildberries и OZON. 
        Твоя задача — отобрать ТОЛЬКО {max_keywords} самых продающих и релевантных ключевых слов из списка 
        для создания заголовков и описаний товаров."""

        user_prompt = f"""
        Контекст товара:
        - Категория: {category}
        - Назначения: {purposes_text}
        - Доп. параметры: {params_text}
        - Описание категории: {category_description[:200] if category_description else "не указано"}

        Критерии отбора ключевых слов (В ПРИОРИТЕТЕ):
        1. **Продающие слова** — которые побуждают к покупке (качество, премиум, выгодно, новинка, хит)
        2. **Конкретика** — точные названия товаров/свойств
        3. **Пользовательский язык** — как ищут реальные покупатели
        4. **Релевантность категории** — точно соответствуют "{category}"
        5. **Учет назначений** — подходят для "{purposes_text}"
        6. **SEO-оптимизация** — популярные поисковые запросы на маркетплейсах
        7. **Коммерческий потенциал** — слова, которые конвертируют в продажи

        ИСКЛЮЧАЙ:
        - Общие слова без конкретики (типа "товар", "изделие")
        - Технические термины, не понятные покупателям
        - Слова с ошибками или опечатками
        - Слишком длинные фразы (больше 3 слов)
        - Устаревшие или непопулярные запросы

        Список ключевых слов для фильтрации: {{keywords_list}}

        Формат ответа: ТОЛЬКО список из {max_keywords} ключевых слов через запятую, без нумерации, без пояснений.
        """

        return system_prompt, user_prompt

    def get_title_prompt(self, category_name: str, purpose: str, additional_params: list) -> str:
        """Промпт для генерации заголовка"""
        prompt = f"""
        Создай продающий заголовок для товара на маркетплейсе со следующими параметрами:

        Категория: {category_name}
        Назначение товара: {purpose}
        Дополнительные параметры: {', '.join(additional_params) if additional_params else 'нет'}

        Требования к заголовку:
        1. Максимально продающий и привлекательный
        2. Включает основные преимущества товара
        3. Соответствует категории "{category_name}"
        4. Оптимизирован для поиска на маркетплейсе
        5. Длина от 5 до 10 слов
        6. Не используй HTML теги
        7. Пиши на русском языке
        8. Не используй специальные символы "!, :, ^, )" и т.д.
        9. Дополнительные параметры должны привлекательно встраиваться в заголовок. Например: не "Зимняя рубашка для Нового года", а "Новогодняя зимняя рубашка"
        10. Ты создаешь заголовок в карточке товара на маркетплейсе
        """
        return prompt

    def get_system_prompt_for_title(self) -> str:
        """Системный промпт для генерации заголовка"""
        return """
        Ты профессиональный копирайтер для маркетплейсов Wildberries и OZON.
        Создавай продающие, естественные заголовки для товаров.
        """

    def get_keywords_prompt(self, title: str, category_name: str) -> str:
        """Промпт для генерации ключевых слов"""
        prompt = f"""
        Извлеки 8-12 ключевых слов из этого заголовка для маркетплейса:

        Заголовок: {title}
        Категория: {category_name}

        Требования к ключевым словам:
        1. Релевантные товару
        2. Популярные для поиска на маркетплейсах
        3. Без стоп-слов
        4. В именительном падеже
        5. Разделяй запятыми

        Верни только список ключевых слов через запятую.
        """
        return prompt

    def get_description_prompt(self, title: str, keywords: list, description_type: str, category: str) -> str:
        """Промпт для генерации описания"""
        type_info = {
            "short": {"length": "краткое", "max_words": "50-100 слов"},
            "long": {"length": "подробное", "max_words": "150-300 слов"}
        }
        info = type_info.get(description_type, {"length": "описание", "max_words": "100-200 слов"})

        prompt = f"""
        Создай {info['length']} описание для товара на маркетплейсе.

        Заголовок товара: {title}
        Ключевые слова: {', '.join(keywords)}
        Категория: {category}

        Требования к описанию:
        1. Продающее и информативное
        2. Естественно включай ключевые слова
        3. Структурированный текст (для длинного описания - с абзацами)
        4. Без эмодзи и HTML тегов
        5. Длина: {info['max_words']}
        6. Пиши на русском языке
        7. Оптимизировано под поиск на маркетплейсе
        """
        return prompt

    def get_system_prompt_for_description(self) -> str:
        """Системный промпт для генерации описания"""
        return """
        Ты профессиональный копирайтер для маркетплейсов.
        Создавай продающие, информативные описания товаров.
        """