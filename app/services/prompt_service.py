# app/services/prompt_service.py
import logging
from typing import List, Optional


class PromptService:
    """Сервис для управления промптами для нейросетей"""

    def __init__(self):
        self.logger = logging.getLogger(__name__)

    def get_keywords_filter_prompt(
            self,
            category: str,
            purposes: List[str],
            additional_params: List[str],
            category_description: str = "",
            max_keywords: int = 25
    ) -> tuple[str, str]:
        """
        Промпт для фильтрации ключевых слов через GPT

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if isinstance(purposes, list) else str(purposes)
        params_text = ", ".join(additional_params) if additional_params else "не указаны"

        system_prompt = f"""Ты — профессиональный маркетолог-копирайтер для маркетплейсов Wildberries и OZON. 
        Твоя задача — отобрать ТОЛЬКО {max_keywords} самых продающих и релевантных ключевых слов из списка 
        для создания заголовков и описаний товаров."""

        user_prompt = f"""
        Контекст товара:
        - Категория: {category}
        - Назначения: {purposes_text}
        - Доп. параметры: {params_text}
        - Описание категории: {category_description[:200] if category_description else "не указано"}

        Критерии отбора ключевых слов (В ПРИОРИТЕТЕ):
        1. **Продающие слова** — которые побуждают к покупке (качество, премиум, выгодно, новинка, хит)
        2. **Конкретика** — точные названия товаров/свойств
        3. **Пользовательский язык** — как ищут реальные покупатели
        4. **Релевантность категории** — точно соответствуют "{category}"
        5. **Учет назначений** — подходят для "{purposes_text}"
        6. **SEO-оптимизация** — популярные поисковые запросы на маркетплейсах
        7. **Коммерческий потенциал** — слова, которые конвертируют в продажи

        ИСКЛЮЧАЙ:
        - Общие слова без конкретики (типа "товар", "изделие")
        - Технические термины, не понятные покупателям
        - Слова с ошибками или опечатками
        - Слишком длинные фразы (больше 3 слов)
        - Устаревшие или непопулярные запросы

        Список ключевых слов для фильтрации: {{keywords_list}}

        Формат ответа: ТОЛЬКО список из {max_keywords} ключевых слов через запятую, без нумерации, без пояснений.
        """

        return system_prompt, user_prompt

    # app/services/prompt_service.py - добавляем новые методы

    def get_wb_title_prompt(self, category: str, purposes: List[str],
                            additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
        """
        Промпт для генерации заголовка Wildberries

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if purposes else ""
        params_text = ", ".join(additional_params) if additional_params else "не указаны"
        keywords_text = ", ".join(keywords[:15])  # Берем первые 15 ключевых слов

        system_prompt = """Ты — профессиональный SEO-копирайтер для маркетплейса Wildberries.
        Твоя задача — создать продающий, релевантный заголовок для карточки товара."""

        user_prompt = f"""
        СОЗДАЙ ЗАГОЛОВОК ДЛЯ WILDBERRIES

        Контекст:
        - Категория товара: {category}
        - Назначения: {purposes_text}
        - Дополнительные параметры: {params_text}
        - Ключевые слова: {keywords_text}

        ТРЕБОВАНИЯ К ЗАГОЛОВКУ:
        1. Длина: до 50 символов
        2. Используй высокочастотные ключевые слова
        3. Будь максимально релевантным и по делу
        4. Отталкивайся от категории и назначений
        5. Используй меньше уточняющих/добавочных ключевых слов
        6. Структура: [Тип товара] + [Ключевая характеристика] + [Назначение]
        7. Без эмодзи, без капслока, без спецсимволов

        Примеры хороших заголовков:
        - Панель ПВХ стеновая белая влагостойкая
        - Самоклеящиеся обои 3D под мрамор
        - Декоративные 3D панели для кухни

        Примеры плохих заголовков:
        - Супер стильные панели премиум класса (маркетинг, нет ключей)
        - Лучшие панели для вашего дома (слишком общее)
        - Панель ПВХ ПВХ ПВХ стеновая панель (спам)

        ВЕРНИ ТОЛЬКО готовый заголовок, без кавычек, без пояснений.
        """

        return system_prompt, user_prompt

    def get_wb_short_desc_prompt(self, category: str, purposes: List[str],
                                 additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
        """
        Промпт для генерации краткого описания Wildberries

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if purposes else ""
        params_text = ", ".join(additional_params) if additional_params else "не указаны"
        keywords_text = ", ".join(keywords[:25])  # Берем 25 ключевых слов

        system_prompt = """Ты — профессиональный SEO-копирайтер для маркетплейса Wildberries.
        Твоя задача — создать краткое, информативное описание товара."""

        user_prompt = f"""
        СОЗДАЙ КРАТКОЕ ОПИСАНИЕ ДЛЯ WILDBERRIES

        Контекст:
        - Категория товара: {category}
        - Назначения: {purposes_text}
        - Дополнительные параметры: {params_text}
        - Ключевые слова: {keywords_text}

        ТРЕБОВАНИЯ К ОПИСАНИЮ:
        1. Длина: до 1000 символов
        2. Используй 20-25 самых высокочастотных и релевантных ключевых слов
        3. Содержание: краткое описание товара, его преимуществ, где можно использовать
        4. Тон: нейтральный, информативный
        5. ЗАПРЕЩЕНО: никаких преувеличений, комплиментов, навязывания покупки, рекламы

        СТРУКТУРА:
        1. Введение (что это за товар)
        2. Основные преимущества
        3. Области применения
        4. Ключевые особенности

        Пример хорошего описания:
        "Декоративные панели из ПВХ предназначены для отделки стен в жилых и коммерческих помещениях.
        Подходят для кухни, ванной комнаты, коридора. Влагостойкие, легко моются, просты в монтаже.
        Можно использовать для создания акцентных стен или полной отделки помещения."

        ВЕРНИ ТОЛЬКО готовое описание, без заголовков, без пояснений.
        """

        return system_prompt, user_prompt

    def get_wb_long_desc_prompt(self, category: str, purposes: List[str],
                                additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
        """
        Промпт для генерации полного описания Wildberries

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if purposes else ""
        params_text = ", ".join(additional_params) if additional_params else "не указаны"
        keywords_text = ", ".join(keywords[:40])  # Берем 40 ключевых слов

        system_prompt = """Ты — профессиональный SEO-копирайтер для маркетплейса Wildberries.
        Твоя задача — создать подробное, структурированное описание товара."""

        user_prompt = f"""
        СОЗДАЙ ПОЛНОЕ ОПИСАНИЕ ДЛЯ WILDBERRIES

        Контекст:
        - Категория товара: {category}
        - Назначения: {purposes_text}
        - Дополнительные параметры: {params_text}
        - Ключевые слова: {keywords_text}

        ТРЕБОВАНИЯ К ОПИСАНИЮ:
        1. Длина: около 2000 символов (на них приходится примерно 40 ключевых слов)
        2. Тон: нейтральный, без преувеличений, без спама ключевыми словами
        3. Структура: 4-5 абзацев текста
        4. Содержание: расплывчатое описание товара, его применения, преимуществ
        5. Ключевые слова: используй естественно, каждый ключ не более 2 раз в тексте
        6. Избегай повторений, делай текст разнообразным

        СТРУКТУРА ТЕКСТА:
        Абзац 1: Общее описание товара и его назначение
        Абзац 2: Преимущества и особенности
        Абзац 3: Области применения
        Абзац 4: Дополнительные характеристики
        Абзац 5: Итоговое заключение

        ПРИМЕР ВЫСОКОКАЧЕСТВЕННОГО ОПИСАНИЯ:
        "Декоративные панели из ПВХ с эффектом 3D — это идеальное решение для создания стильного и современного интерьера в вашем доме. Эти влагостойкие пластиковые плиты прекрасно подойдут для отделки стен в спальне, гостиной, кухне, ванной, туалете или коридоре. Они легко устанавливаются и подходят для использования в любых помещениях, включая коммерческие помещения и дачу.

        Каждая плитка оформлена оригинальным рисунком, что позволяет создать уникальный декор. Такие панели не только придают эстетичный вид, но и защищают стены от повреждений и загрязнений благодаря моющим свойствам материала. Вы можете использовать их для фартука на кухне или как отделку в прихожей — возможности безграничны.

        Упаковка содержит 15 штук панелей, что облегчает процесс ремонта и позволяет быстро обновить интерьер. Эти изделия созданы из качественных материалов, обеспечивая долговечность и надежность покрытия. Декоративные стеновые панели легко чистятся и устойчивы к влаге, что делает их идеальными для помещений с повышенной влажностью.

        При помощи этих 3D панелей вы сможете преобразить пространство вашего дома без значительных затрат времени и усилий. Инновационный подход к дизайну интерьеров поможет вам создать уютную атмосферу в каждой комнате. Используйте данные панели для создания стильных акцентов или же полного преображения вашего пространства.

        Не упустите возможность сделать ваш дом более привлекательным с помощью современных декоративных решений!"

        ВЕРНИ ТОЛЬКО готовое описание, без заголовков, без пояснений.
        """

        return system_prompt, user_prompt

    def get_ozon_title_prompt(self, category: str, purposes: List[str],
                              additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
        """
        Промпт для генерации SEO-названия Ozon

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if purposes else ""
        params_text = ", ".join(additional_params) if additional_params else "не указаны"
        keywords_text = ", ".join(keywords[:20])  # Берем 20 ключевых слов

        system_prompt = """Ты — профессиональный SEO-специалист для маркетплейса Ozon.
        Твоя задача — создать SEO-оптимизированное название товара по правилам Ozon."""

        user_prompt = f"""
        СОЗДАЙ SEO-НАЗВАНИЕ ДЛЯ OZON

        Контекст:
        - Категория товара: {category}
        - Назначения: {purposes_text}
        - Дополнительные параметры: {params_text}
        - Ключевые слова: {keywords_text}

        ПРАВИЛА СОЗДАНИЯ SEO-НАЗВАНИЯ НА OZON:
        1. НАЗВАНИЕ = ГЛАВНЫЙ ПОИСКОВЫЙ ЗАПРОС
        2. Один товар — один основной запрос
        3. Структура: [Тип товара] + [Ключевая характеристика] + [Назначение/Формат] + [Важные уточнения]
        4. Оптимальная длина: 120–160 символов
        5. Первые 60–70 символов — самые важные (их видно в поиске)

        ЧТО ОБЯЗАТЕЛЬНО ДОЛЖНО БЫТЬ В НАЗВАНИИ:
        ✅ Тип товара (панель ПВХ, обои, фартук и т.д.)
        ✅ Основной ключ (то, как ищут: «стеновая», «самоклеящаяся», «под дерево»)
        ✅ 1–2 сильные характеристики (цвет, размер, влагостойкость, назначение)

        ЧЕГО НЕЛЬЗЯ ДЕЛАТЬ:
        ❌ Переспам ключами (панель пвх стеновая пвх панель)
        ❌ Маркетинговые слова без смысла (лучшая, топ, премиум, супер, хит)
        ❌ КАПСЛОК, смайлы, спецсимволы
        ❌ Повтор информации, которая уже есть в характеристиках

        ПРИМЕРЫ ХОРОШИХ НАЗВАНИЙ:
        - Панель ПВХ стеновая под мрамор белая влагостойкая 2700×250 мм
        - Обои самоклеящиеся 3D под кирпич для кухни 45×250 см
        - Фартук пластиковый для кухни с рисунком 60×90 см

        ПРИМЕРЫ ПЛОХИХ НАЗВАНИЙ:
        - Стильная дизайнерская панель премиум класса для вашего интерьера (нет поисковых слов)
        - Панель ПВХ ПВХ ПВХ стеновая панель (спам)
        - ЛУЧШАЯ ПАНЕЛЬ ДЛЯ ДОМА!!! (капслок, маркетинг)

        ВЕРНИ ТОЛЬКО готовое название, без кавычек, без пояснений.
        """

        return system_prompt, user_prompt

    def get_ozon_desc_prompt(self, category: str, purposes: List[str],
                             additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
        """
        Промпт для генерации SEO-описания Ozon

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if purposes else ""
        params_text = ", ".join(additional_params) if additional_params else "не указаны"
        keywords_text = ", ".join(keywords[:30])  # Берем 30 ключевых слов

        # Формируем основной ключ (первое ключевое слово + назначение)
        main_keyword = keywords[0] if keywords else category
        main_keyword_full = f"{main_keyword} {purposes_text}" if purposes_text else main_keyword

        system_prompt = """Ты — профессиональный SEO-специалист для маркетплейса Ozon.
        Твоя задача — создать SEO-оптимизированное описание товара по правилам Ozon."""

        user_prompt = f"""
        СОЗДАЙ SEO-ОПИСАНИЕ ДЛЯ OZON

        Контекст:
        - Категория товара: {category}
        - Назначения: {purposes_text}
        - Дополнительные параметры: {params_text}
        - Ключевые слова: {keywords_text}
        - Основной ключ: {main_keyword_full}

        ПРАВИЛА СОЗДАНИЯ SEO-ОПИСАНИЯ НА OZON:
        1. ОПИСАНИЕ = УСИЛЕНИЕ РЕЛЕВАНТНОСТИ И КОНВЕРСИИ
        2. Объём: 1500–3000 знаков (оптимально)
        3. Ozon — это не Google: точные формулировки важнее художественного текста

        СТРУКТУРА ЭФФЕКТИВНОГО SEO-ОПИСАНИЯ:
        1. ВВОДНЫЙ АБЗАЦ: первые 2–3 предложения с основным ключом
        2. ПОЛЬЗА И ПРИМЕНЕНИЕ: где и как используется товар
        3. ПРЕИМУЩЕСТВА: маркированный список (обязательно!)
        4. ДОПОЛНИТЕЛЬНЫЕ ФОРМУЛИРОВКИ: LSI-слова и синонимы

        ИСПОЛЬЗОВАНИЕ КЛЮЧЕВЫХ СЛОВ:
        ✅ Основной ключ — 2–3 раза в тексте
        ✅ Дополнительные ключи — 1 раз каждый
        ✅ LSI-слова и синонимы — обязательно
        ❌ ЗАПРЕЩЕН СПАМ: не повторяй ключи много раз

        LSI-СЛОВА ДЛЯ ПРИМЕРА (используй похожие):
        - отделка стен
        - декоративные панели
        - внутренняя отделка
        - ремонт без грязи
        - монтаж своими руками

        ПРИМЕР ХОРОШЕГО ВВОДНОГО АБЗАЦА:
        "Стеновая панель ПВХ под мрамор — практичное решение для отделки стен в ванной, кухне и коридоре. Панели ПВХ отличаются влагостойкостью, простотой ухода и аккуратным внешним видом."

        ПРИМЕР МАРКИРОВАННОГО СПИСКА:
        • Влагостойкая поверхность
        • Подходит для кухни и ванной
        • Легко моется
        • Аккуратная геометрия рисунка
        • Простой монтаж

        ВЕРНИ ТОЛЬКО готовое описание, без заголовков, без пояснений.
        Обязательно включи маркированный список преимуществ!
        """

        return system_prompt, user_prompt

    def get_title_prompt(self, category_name: str, purpose: str, additional_params: list) -> str:
        """Промпт для генерации заголовка"""
        prompt = f"""
        Создай продающий заголовок для товара на маркетплейсе со следующими параметрами:

        Категория: {category_name}
        Назначение товара: {purpose}
        Дополнительные параметры: {', '.join(additional_params) if additional_params else 'нет'}

        Требования к заголовку:
        1. Максимально продающий и привлекательный
        2. Включает основные преимущества товара
        3. Соответствует категории "{category_name}"
        4. Оптимизирован для поиска на маркетплейсе
        5. Длина от 5 до 10 слов
        6. Не используй HTML теги
        7. Пиши на русском языке
        8. Не используй специальные символы "!, :, ^, )" и т.д.
        9. Дополнительные параметры должны привлекательно встраиваться в заголовок. Например: не "Зимняя рубашка для Нового года", а "Новогодняя зимняя рубашка"
        10. Ты создаешь заголовок в карточке товара на маркетплейсе
        """
        return prompt

    def get_system_prompt_for_title(self) -> str:
        """Системный промпт для генерации заголовка"""
        return """
        Ты профессиональный копирайтер для маркетплейсов Wildberries и OZON.
        Создавай продающие, естественные заголовки для товаров.
        """

    def get_keywords_prompt(self, title: str, category_name: str) -> str:
        """Промпт для генерации ключевых слов"""
        prompt = f"""
        Извлеки 8-12 ключевых слов из этого заголовка для маркетплейса:

        Заголовок: {title}
        Категория: {category_name}

        Требования к ключевым словам:
        1. Релевантные товару
        2. Популярные для поиска на маркетплейсах
        3. Без стоп-слов
        4. В именительном падеже
        5. Разделяй запятыми

        Верни только список ключевых слов через запятую.
        """
        return prompt

    def get_description_prompt(self, title: str, keywords: list, description_type: str, category: str) -> str:
        """Промпт для генерации описания"""
        type_info = {
            "short": {"length": "краткое", "max_words": "50-100 слов"},
            "long": {"length": "подробное", "max_words": "150-300 слов"}
        }
        info = type_info.get(description_type, {"length": "описание", "max_words": "100-200 слов"})

        prompt = f"""
        Создай {info['length']} описание для товара на маркетплейсе.

        Заголовок товара: {title}
        Ключевые слова: {', '.join(keywords)}
        Категория: {category}

        Требования к описанию:
        1. Продающее и информативное
        2. Естественно включай ключевые слова
        3. Структурированный текст (для длинного описания - с абзацами)
        4. Без эмодзи и HTML тегов
        5. Длина: {info['max_words']}
        6. Пиши на русском языке
        7. Оптимизировано под поиск на маркетплейсе
        """
        return prompt

    def get_system_prompt_for_description(self) -> str:
        """Системный промпт для генерации описания"""
        return """
        Ты профессиональный копирайтер для маркетплейсов.
        Создавай продающие, информативные описания товаров.
        """