# app/services/prompt_service.py
import logging
from typing import List, Optional


class PromptService:
    """Сервис для управления промптами для нейросетей"""

    def __init__(self):
        self.logger = logging.getLogger(__name__)

    def get_keywords_filter_prompt(
            self,
            category: str,
            purposes: List[str],
            additional_params: List[str],
            category_description: str = "",
            max_keywords: int = 25
    ) -> tuple[str, str]:
        """
        Промпт для фильтрации ключевых слов через GPT

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if isinstance(purposes, list) else str(purposes)
        params_text = ", ".join(additional_params) if additional_params else "не указаны"

        system_prompt = f"""Ты — профессиональный маркетолог-копирайтер для маркетплейсов Wildberries и OZON. 
        Твоя задача — отобрать ТОЛЬКО {max_keywords} самых продающих и релевантных ключевых слов из списка 
        для создания заголовков и описаний товаров."""

        user_prompt = f"""
        Контекст товара:
        - Категория: {category}
        - Назначения: {purposes_text}
        - Доп. параметры: {params_text}
        - Описание категории: {category_description if category_description else "не указано"}

        Критерии отбора ключевых слов (В ПРИОРИТЕТЕ):
        1. **Продающие слова** — которые побуждают к покупке (качество, премиум, выгодно, новинка, хит)
        2. **Конкретика** — точные названия товаров/свойств
        3. **Пользовательский язык** — как ищут реальные покупатели
        4. **Релевантность категории** — точно соответствуют "{category}"
        5. **Учет назначений** — подходят для "{purposes_text}"
        6. **SEO-оптимизация** — популярные поисковые запросы на маркетплейсах
        7. **Коммерческий потенциал** — слова, которые конвертируют в продажи

        ИСКЛЮЧАЙ:
        - Общие слова без конкретики (типа "товар", "изделие")
        - Технические термины, не понятные покупателям
        - Слова с ошибками или опечатками
        - Слишком длинные фразы (больше 3 слов)
        - Устаревшие или непопулярные запросы

        Список ключевых слов для фильтрации: {{keywords_list}}

        Формат ответа: ТОЛЬКО список из {max_keywords} ключевых слов через запятую, без нумерации, без пояснений.
        """

        return system_prompt, user_prompt

    #1 тестовый
    # def get_wb_title_prompt(self, category: str, purposes: List[str],
    #                         additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
    #     """
    #     Промпт для генерации заголовка Wildberries по строгим правилам
    #
    #     Returns:
    #         Кортеж (system_prompt, user_prompt)
    #     """
    #     purposes_text = ", ".join(purposes) if purposes else ""
    #     params_text = ", ".join(additional_params) if additional_params else "не указаны"
    #     keywords_text = ", ".join(keywords[:25])  # Берем первые 20 ключевых слов для анализа
    #
    #     # Анализируем ключевые слова для определения высокочастотных запросов
    #     category_keywords = [kw for kw in keywords if category.lower() in kw.lower()]
    #     purpose_keywords = []
    #     if purposes:
    #         for purpose in purposes:
    #             purpose_keywords.extend([kw for kw in keywords if purpose.lower() in kw.lower()])
    #
    #     # Выбираем самый релевантный и высокочастотный запрос
    #     primary_query = category_keywords[0] if category_keywords else category
    #     purpose_phrases = purpose_keywords[:2] if purpose_keywords else purposes[:2] if purposes else []
    #
    #     system_prompt = """Ты — генератор заголовков для маркетплейса Wildberries.
    #     Твоя задача — создавать строгие фактические заголовки ПРЕИМУЩЕСТВЕННО из ключевых слов,
    #     без эмоций, маркетинга и оценочных суждений."""
    #
    #     user_prompt = f"""
    #     СОЗДАЙ ЗАГОЛОВОК ДЛЯ WILDBERRIES ПО СТРОГИМ ПРАВИЛАМ
    #
    #     КОНТЕКСТ:
    #     - Категория товара: {category}
    #     - Назначения: {purposes_text}
    #     - Дополнительные параметры: {params_text}
    #     - Ключевые слова: {keywords_text}
    #
    #     ПРАВИЛА СОЗДАНИЯ ЗАГОЛОВКА:
    #
    #     1. СТРУКТУРА (ОБЯЗАТЕЛЬНО):
    #        - В НАЧАЛЕ: самый релевантный и высокочастотный запрос (смотри ключевые слова)
    #        - ЗАТЕМ: назначение ("под камень", "для ванной" и т.д.) - что более высокочастотное
    #        - ДЛЯ ПАНЕЛЕЙ: добавить "ПВХ" в нужном месте для хорошей читаемости
    #        - ДОПОЛНИТЕЛЬНО: 1-2 ключевых слова из сочетания категории + назначения
    #
    #     2. ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ:
    #        - Минимум 50 симоволов
    #        - Максимум 60 символов
    #        - Без знаков препинания (ни точек, ни запятых, ни тире)
    #        - Без капслока, восклицательных знаков, спецсимволов
    #        - Только строчные буквы (кроме аббревиатур типа ПВХ, 3D, начала строки)
    #
    #     3. КРИТИЧЕСКИ ВАЖНО (ЧТО ИСКЛЮЧИТЬ):
    #        ❌ ЛЮБЫЕ эмоции и маркетинг
    #        ❌ Оценочные слова: "лучший", "качественный", "надёжный", "стильный", "премиум"
    #        ❌ Пустые слова: "топ", "хит", "акция", "выгодный", "популярный"
    #        ❌ Преувеличения: "супер", "мега", "ультра"
    #
    #
    #     4. ЧТО ДОЛЖНО БЫТЬ:
    #        ✅ Только факты из ключевых слов
    #        ✅ Конкретные характеристики
    #        ✅ Названия материалов (ПВХ, ПЭТ, МДФ и т.д.)
    #        ✅ Назначение и применение
    #        ✅ Количественные данные (размеры, количество в упаковке)
    #
    #     5. АНАЛИЗ КЛЮЧЕВЫХ СЛОВ ДЛЯ ЭТОЙ КАТЕГОРИИ:
    #        - Основной запрос: {primary_query}
    #        - Назначения из ключевых слов: {', '.join(purpose_keywords) if purpose_keywords else 'нет'}
    #        - Категория из ключевых слов: {', '.join(category_keywords) if category_keywords else 'нет'}
    #
    #     6. ПРИМЕРЫ ПРАВИЛЬНЫХ ЗАГОЛОВКОВ:
    #        Для ПВХ панелей: "Панели для стен ПВХ декоративная 3д плитка 15 шт"
    #        Для обоев: "Обои самоклеящиеся под кирпич для кухни 45х250 см"
    #        Для фартуков: "Фартук для кухни пластиковый с рисунком 60х90 см"
    #
    #     7. ПРИМЕРЫ НЕПРАВИЛЬНЫХ ЗАГОЛОВКОВ:
    #        ❌ "Лучшие стильные панели премиум класса" (маркетинг)
    #        ❌ "Супер качественные обои для вашего дома" (эмоции)
    #        ❌ "Панели! Акция! Выгодно!!!" (спецсимволы, эмоции)
    #        ❌ "Топовые панели пвх" (пустые слова)
    #        ❌ "белая виниловая декор для кухни 48*48"
    #
    #     ВАЖНО: Составь заголовок МАКСИМИЗУРУЯ в нем ключевые слова из представленного списка,
    #     комбинируя их в указанном порядке.
    #
    #     ВЕРНИ ТОЛЬКО готовый заголовок (максимум 60 символов), без кавычек, без пояснений.
    #     """
    #
    #     return system_prompt, user_prompt

    #2 тестовый
    def get_wb_title_prompt(self, category: str, purposes: List[str],
                            additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
        """
        Улучшенный промпт для генерации заголовка Wildberries с учетом MPStats
        Оптимизирован для GPT-3.5 Turbo

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if purposes else ""
        params_text = ", ".join(additional_params) if additional_params else "не указаны"

        # Берем топ-15 ключевых слов для анализа частотности
        top_keywords = keywords[:15] if keywords else []
        keywords_text = ", ".join(top_keywords)

        system_prompt = """Ты — строгий SEO-специалист Wildberries. Твоя единственная задача — создавать заголовки для карточек товаров по абсолютным правилам.

    ПРАВИЛА КОТОРЫЕ ТЫ НЕ МОЖЕШЬ НАРУШАТЬ:
    1. ТОЛЬКО ФАКТЫ — никаких оценок, эмоций, маркетинга
    2. НИКАКИХ ЗНАКОВ ПРЕПИНАНИЯ — только пробелы между словами
    3. НИКАКОГО КАПСЛОКА (кроме ПВХ, 3D)
    4. НИКАКИХ СПЕЦСИМВОЛОВ
    5. НИКАКИХ ЭМОДЗИ
    6. МАКСИМУМ 60 СИМВОЛОВ — проверяй длину
    7. СТРОГАЯ СТРУКТУРА (описана ниже)

    ЗАПРЕЩЕННЫЕ СЛОВА (НИКОГДА НЕ ИСПОЛЬЗУЙ):
    • качественный, лучший, надежный, стильный, премиум
    • легкий, удобный, простой, выгодный
    • топ, хит, акция, популярный
    • очень, самый, достаточно, довольно
    • супер, мега, ультра, эксклюзивный
    • замечательный, прекрасный, удивительный

    ТЫ НЕ ИМЕЕШЬ ПРАВА ИСПОЛЬЗОВАТЬ ЭТИ СЛОВА НИ ПРИ КАКИХ УСЛОВИЯХ."""

        user_prompt = f"""
    ====== КРИТИЧЕСКИ ВАЖНАЯ ИНСТРУКЦИЯ ДЛЯ СОЗДАНИЯ ЗАГОЛОВКА WILDBERRIES ======

    АНАЛИЗ ДАННЫХ:
    • КАТЕГОРИЯ: {category}
    • НАЗНАЧЕНИЯ: {purposes_text}
    • ДОПОЛНИТЕЛЬНЫЕ ПАРАМЕТРЫ: {params_text}
    • КЛЮЧЕВЫЕ СЛОВА ИЗ MPStats (топ-15): {keywords_text}

    СТРОГАЯ СТРУКТУРА ЗАГОЛОВКА (СОБЛЮДАЙ ТОЧНЫЙ ПОРЯДОК):

    ШАГ 1: ВЗЯТЬ САМЫЙ ВЫСОКОЧАСТОТНЫЙ ЗАПРОС ИЗ MPStats
    Смотри список ключевых слов выше. Выбери ОДИН самый частотный запрос, который точно соответствует категории товара.
    Пример для панелей: "Панели для стен"
    Пример для обоев: "Обои самоклеящиеся"
    Пример для фартуков: "Фартук для кухни"

    ШАГ 2: ДОБАВИТЬ ВЫСОКОЧАСТОТНОЕ НАЗНАЧЕНИЕ
    Смотри ключевые слова и назначения. Выбери самое частотное назначение.
    Примеры: "под камень", "для ванной", "для кухни", "3D"
    Если несколько назначений — выбери ОДНО самое важное.

    ШАГ 3: ДЛЯ ПАНЕЛЕЙ — ДОБАВИТЬ "ПВХ" В НУЖНОЕ МЕСТО
    Если это панели (любые панели) — добавь "ПВХ" после первой фразы, но так чтобы читалось естественно.
    Пример: "Панели для стен ПВХ" (а не "Панели ПВХ для стен")

    ШАГ 4: ДОБАВИТЬ 1-2 КЛЮЧЕВЫХ СЛОВА ИЗ КОМБИНАЦИИ
    Возьми 1-2 ключевых слова из MPStats, которые сочетают категорию + назначение.
    Пример: если категория "панели" и назначение "для кухни", ищи в ключах "влагостойкие", "кухонные"

    ШАГ 5: ДОБАВИТЬ КОНКРЕТНУЮ ХАРАКТЕРИСТИКУ
    Ищи в ключевых словах: размеры (45х250 см), количество (15 шт), материал (пластик)
    Пример: "2700х250 мм", "15 шт", "пластиковый"
    ВАЖНО: Если в дополнительных параметрах (конкретных характеристиках) не были переданы размеры товара, то НЕ УКАЗЫВАЙ НИКАКИЕ РАЗМЕРЫ ТОВАРА!

    ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ (ПРОВЕРЬ ПЕРЕД ОТВЕТОМ):
    1. Длина: СЧИТАЙ СИМВОЛЫ. Максимум 60 символов.
    2. Знаки препинания: УБЕРИ ВСЕ. Ни точек, ни запятых, ни тире.
    3. Регистр: только строчные буквы (кроме ПВХ, 3D).
    4. Структура: строго как в шагах 1-5 выше.

    ПРИМЕРЫ ПРАВИЛЬНЫХ ЗАГОЛОВКОВ:
    • Панели для стен ПВХ декоративная 3д плитка 15 шт 
    • Обои самоклеящиеся под кирпич для кухни 45х250 см 
    • Фартук для кухни пластиковый с рисунком 60х90 см 

    ПРИМЕРЫ НЕПРАВИЛЬНЫХ ЗАГОЛОВКОВ:
    ❌ "Лучшие панели премиум класса для вашего дома" (маркетинг)
    ❌ "Панели! Для стен! ПВХ!" (знаки препинания)
    ❌ "ПАНЕЛИ ДЛЯ СТЕН ПВХ" (капслок)
    ❌ "Супер качественные обои самоклеящиеся" (запрещенные слова)

    АНАЛИЗ ТВОИХ КЛЮЧЕВЫХ СЛОВ:
    Просмотри внимательно эти ключи из MPStats: {keywords_text}
    Из них выбери:
    1. Самый высокочастотный запрос для категории "{category}"
    2. Самое высокочастотное назначение из "{purposes_text}"
    3. Конкретные характеристики (размеры, количество, материал) из "{params_text}"

    ВАЖНОЕ ПРАВИЛО:
    Wildberries игнорирует "водные" слова. Каждое слово должно нести конкретную информацию о товаре.
    Если заголовок длиннее 60 символов — удали наименее важные слова, начиная с конца.

    СОЗДАЙ ЗАГОЛОВОК ПО ЭТОМУ АЛГОРИТМУ:
    1. [Высокочастотный запрос из MPStats]
    2. [Добавить "ПВХ" если панели]
    3. [Высокочастотное назначение]
    4. [1-2 ключа из категории+назначения]
    5. [Конкретная характеристика]

    ВЕРНИ ТОЛЬКО ГОТОВЫЙ ЗАГОЛОВОК, БЕЗ КАВЫЧЕК, БЕЗ ПОЯСНЕНИЙ, БЕЗ НОМЕРАЦИИ.
    ПЕРЕД ОТВЕТОМ ПРОЧТИ ЗАГОЛОВОК И ПРОВЕРЬ ВСЕ ПРАВИЛА.
    """

        return system_prompt, user_prompt

    def get_wb_short_desc_prompt(self, category: str, purposes: List[str],
                                 additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
        """
        Промпт для генерации краткого описания Wildberries

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if purposes else ""
        params_text = ", ".join(additional_params) if additional_params else "не указаны"
        keywords_text = ", ".join(keywords[:25])  # Берем 25 ключевых слов

        system_prompt = """Ты — профессиональный SEO-копирайтер для маркетплейса Wildberries.
        Твоя задача — создать краткое, информативное описание товара."""

        user_prompt = f"""
        СОЗДАЙ КРАТКОЕ ОПИСАНИЕ ДЛЯ WILDBERRIES

        Контекст:
        - Категория товара: {category}
        - Назначения: {purposes_text}
        - Дополнительные параметры: {params_text}
        - Ключевые слова: {keywords_text}

        ТРЕБОВАНИЯ К ОПИСАНИЮ:
        1. Длина: от 800 до 1000 символов
        2. Используй 20-25 самых высокочастотных и релевантных ключевых слов
        3. Содержание: краткое описание товара, его преимуществ, где можно использовать
        4. Тон: нейтральный, информативный
        5. ЗАПРЕЩЕНО: никаких преувеличений, комплиментов, навязывания покупки, рекламы

        СТРУКТУРА:
        1. Введение (что это за товар)
        2. Основные преимущества
        3. Области применения
        4. Ключевые особенности

        Пример хорошего описания:
        "Декоративные панели из ПВХ предназначены для отделки стен в жилых и коммерческих помещениях.
        Подходят для кухни, ванной комнаты, коридора. Влагостойкие, легко моются, просты в монтаже.
        Можно использовать для создания акцентных стен или полной отделки помещения."

        ВЕРНИ ТОЛЬКО готовое описание, без заголовков, без пояснений, не используй такие слова как "Новинка" и "Хит продаж", избегай упоминания страны изготовителя.
        """

        return system_prompt, user_prompt

    # def get_wb_short_desc_prompt(self, category: str, purposes: List[str],
    #                              additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
    #     """
    #     Промпт для генерации КРАТКОГО описания Wildberries (SEO-оптимизированного)
    #     Адаптировано под подход Ozon: факты, польза, применение
    #
    #     Returns:
    #         Кортеж (system_prompt, user_prompt)
    #     """
    #     purposes_text = ", ".join(purposes) if purposes else ""
    #     params_text = ", ".join(additional_params) if additional_params else "не указаны"
    #     keywords_text = ", ".join(keywords[:20])  # Берем 20 ключевых слов
    #
    #     # Анализируем ключевые слова для LSI
    #     lsi_keywords = self._extract_lsi_keywords(keywords, category, purposes)
    #
    #     system_prompt = """Ты — SEO-копирайтер для маркетплейса Wildberries.
    #     Создай краткое, информативное описание ТОЛЬКО из фактов, без маркетинга и эмоций."""
    #
    #     user_prompt = f"""
    #     СОЗДАЙ КРАТКОЕ SEO-ОПИСАНИЕ ДЛЯ WILDBERRIES
    #
    #     КОНТЕКСТ:
    #     - Категория товара: {category}
    #     - Назначения: {purposes_text}
    #     - Дополнительные параметры: {params_text}
    #     - Ключевые слова: {keywords_text}
    #     - LSI-слова: {', '.join(lsi_keywords[:10])}
    #
    #     ПРАВИЛА СОЗДАНИЯ КРАТКОГО ОПИСАНИЯ:
    #
    #     1. ОСНОВНЫЕ ТРЕБОВАНИЯ:
    #        - Длина: 500-700 символов (оптимально для краткого описания)
    #        - Тон: строго информативный, нейтральный, без эмоций
    #        - Содержание: только факты, характеристики, применение
    #        - Цель: усилить релевантность товара в поиске
    #
    #     2. СТРУКТУРА (ОБЯЗАТЕЛЬНО СОБЛЮДАТЬ ПОСЛЕДОВАТЕЛЬНОСТЬ):
    #        1. ВВОДНЫЙ АБЗАЦ (2-3 предложения):
    #           - Что это за товар (название категории)
    #           - Основное назначение (где используется)
    #           - Ключевое преимущество (из дополнительных параметров)
    #
    #        2. ОСНОВНЫЕ ХАРАКТЕРИСТИКИ:
    #           - Материал (если указан в ключевых словах)
    #           - Размеры/формат (если есть в данных)
    #           - Особенности монтажа/использования
    #
    #        3. ОБЛАСТИ ПРИМЕНЕНИЯ (маркированный список из 3-4 пунктов):
    #           • Конкретные помещения (кухня, ванная, спальня и т.д.)
    #           • Типы объектов (квартира, дом, офис, коммерция)
    #           • Особые случаи применения
    #
    #        4. ЗАКЛЮЧЕНИЕ (1-2 предложения):
    #           - Резюме основных преимуществ
    #           - Указание на универсальность/практичность
    #
    #     3. ИСПОЛЬЗОВАНИЕ КЛЮЧЕВЫХ СЛОВ:
    #        ✅ Основные ключи: использовать 2-3 раза в тексте естественно
    #        ✅ LSI-слова: обязательно включить синонимы и смежные понятия
    #        ✅ Назначения: упоминать в каждом абзаце, где уместно
    #        ❌ ЗАПРЕТ: спам ключевыми словами, неестественные вставки
    #
    #     4. ЧТО ОБЯЗАТЕЛЬНО ВКЛЮЧИТЬ:
    #        - Указание материала изготовления (ПВХ, МДФ, пластик и т.д.)
    #        - Сферы применения (конкретные помещения или задачи)
    #        - Ключевые особенности из дополнительных параметров
    #        - Информацию о монтаже/установке (если релевантно)
    #
    #     5. ЧТО ИСКЛЮЧИТЬ ПОЛНОСТЬЮ:
    #        ❌ Оценочные слова: "качественный", "надёжный", "стильный"
    #        ❌ Маркетинг: "премиум", "хит продаж", "выгодная цена"
    #        ❌ Эмоции: "прекрасный", "великолепный", "удобный"
    #        ❌ Преувеличения: "самый лучший", "уникальный", "эксклюзивный"
    #        ❌ Призывы к действию: "купите сейчас", "не упустите шанс"
    #
    #     6. LSI-СЛОВА ДЛЯ ЭТОЙ КАТЕГОРИИ (добавить в текст естественно):
    #        - отделка стен, внутренняя отделка, ремонт
    #        - декоративные элементы, интерьерные решения
    #        - влагостойкость, износостойкость, практичность
    #        - монтаж своими руками, быстрая установка
    #        - уход и очистка, простота обслуживания
    #
    #     7. ПРИМЕР ХОРОШЕГО КРАТКОГО ОПИСАНИЯ:
    #        "Панели ПВХ для стен предназначены для внутренней отделки жилых и коммерческих помещений.
    #        Изготовлены из влагостойкого пластика, подходят для кухни, ванной комнаты и коридора.
    #
    #        Основные характеристики:
    #        • Материал: ПВХ высокой плотности
    #        • Формат: прямоугольные панели
    #        • Особенности: легко моются, устойчивы к влаге
    #
    #        Области применения:
    #        • Отделка стен в помещениях с повышенной влажностью
    #        • Создание акцентных стен в гостиной или спальне
    #        • Отделка коммерческих объектов (кафе, офисы, магазины)
    #
    #        Панели отличаются простотой монтажа и долговечностью использования."
    #
    #     ВЕРНИ ТОЛЬКО готовое описание, без заголовков, без пояснений.
    #     Строго соблюдай структуру и требования по длине.
    #     """
    #
    #     return system_prompt, user_prompt

    # def get_wb_long_desc_prompt(self, category: str, purposes: List[str],
    #                             additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
    #     """
    #     Промпт для генерации полного описания Wildberries
    #
    #     Returns:
    #         Кортеж (system_prompt, user_prompt)
    #     """
    #     purposes_text = ", ".join(purposes) if purposes else ""
    #     params_text = ", ".join(additional_params) if additional_params else "не указаны"
    #     keywords_text = ", ".join(keywords[:25])  # Берем 40 ключевых слов
    #
    #     system_prompt = """Ты — профессиональный SEO-копирайтер для маркетплейса Wildberries.
    #     Твоя задача — создать подробное, структурированное описание товара."""
    #
    #     user_prompt = f"""
    #     СОЗДАЙ ПОЛНОЕ ОПИСАНИЕ ДЛЯ WILDBERRIES
    #
    #     Контекст:
    #     - Категория товара: {category}
    #     - Назначения: {purposes_text}
    #     - Дополнительные параметры: {params_text}
    #     - Ключевые слова: {keywords_text}
    #
    #     ТРЕБОВАНИЯ К ОПИСАНИЮ:
    #     1. Длина: около 2000 символов (на них приходится примерно 40 ключевых слов)
    #     2. Тон: нейтральный, без преувеличений, без спама ключевыми словами
    #     3. Структура: 4-5 абзацев текста
    #     4. Содержание: расплывчатое описание товара, его применения, преимуществ
    #     5. Ключевые слова: используй естественно, каждый ключ не более 2 раз в тексте
    #     6. Избегай повторений, делай текст разнообразным
    #
    #     СТРУКТУРА ТЕКСТА:
    #     Абзац 1: Общее описание товара и его назначение
    #     Абзац 2: Преимущества и особенности
    #     Абзац 3: Области применения
    #     Абзац 4: Дополнительные характеристики
    #     Абзац 5: Итоговое заключение
    #
    #     ПРИМЕР ВЫСОКОКАЧЕСТВЕННОГО ОПИСАНИЯ:
    #     "Декоративные панели из ПВХ с эффектом 3D — это идеальное решение для создания стильного и современного интерьера в вашем доме. Эти влагостойкие пластиковые плиты прекрасно подойдут для отделки стен в спальне, гостиной, кухне, ванной, туалете или коридоре. Они легко устанавливаются и подходят для использования в любых помещениях, включая коммерческие помещения и дачу.
    #
    #     Каждая плитка оформлена оригинальным рисунком, что позволяет создать уникальный декор. Такие панели не только придают эстетичный вид, но и защищают стены от повреждений и загрязнений благодаря моющим свойствам материала. Вы можете использовать их для фартука на кухне или как отделку в прихожей — возможности безграничны.
    #
    #     Упаковка содержит 15 штук панелей, что облегчает процесс ремонта и позволяет быстро обновить интерьер. Эти изделия созданы из качественных материалов, обеспечивая долговечность и надежность покрытия. Декоративные стеновые панели легко чистятся и устойчивы к влаге, что делает их идеальными для помещений с повышенной влажностью.
    #
    #     При помощи этих 3D панелей вы сможете преобразить пространство вашего дома без значительных затрат времени и усилий. Инновационный подход к дизайну интерьеров поможет вам создать уютную атмосферу в каждой комнате. Используйте данные панели для создания стильных акцентов или же полного преображения вашего пространства.
    #
    #     Не упустите возможность сделать ваш дом более привлекательным с помощью современных декоративных решений!"
    #
    #     ВЕРНИ ТОЛЬКО готовое описание, без заголовков, без пояснений.
    #     """
    #
    #     return system_prompt, user_prompt

    def get_wb_long_desc_prompt(self, category: str, purposes: List[str],
                                additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
        """
        Промпт для генерации ПОЛНОГО описания Wildberries (SEO-оптимизированного)
        Адаптировано под глубокий SEO-подход Ozon

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if purposes else ""
        params_text = ", ".join(additional_params) if additional_params else "не указаны"
        keywords_text = ", ".join(keywords[:30])  # Берем 30 ключевых слов

        # Анализируем ключевые слова для расширенного LSI
        lsi_keywords = self._extract_lsi_keywords(keywords, category, purposes)
        extended_lsi = self._get_extended_lsi_clusters(category, purposes)

        # Определяем основные тематические кластеры
        clusters = self._identify_seo_clusters(keywords, category, purposes)

        system_prompt = """Ты — профессиональный SEO-специалист для Wildberries. 
        Создай глубоко оптимизированное полное описание с тематическими кластерами и LSI-словами."""

        user_prompt = f"""
        СОЗДАЙ ПОЛНОЕ SEO-ОПИСАНИЕ ДЛЯ WILDBERRIES

        КОНТЕКСТ:
        - Категория товара: {category}
        - Назначения: {purposes_text}
        - Дополнительные параметры: {params_text}
        - Ключевые слова: {keywords_text}
        - LSI-слова: {', '.join(lsi_keywords[:15])}
        - Тематические кластеры: {', '.join(clusters)}

        ПРАВИЛА СОЗДАНИЯ ПОЛНОГО SEO-ОПИСАНИЯ:

        1. ТЕХНИЧЕСКИЕ ТРЕБОВАНИЯ:
           - Длина: 1500-2000 символов (глубокое описание)
           - Структура: 5-6 тематических абзацев
           - Плотность ключей: 3-5% (естественное вхождение)
           - Цель: максимальная релевантность + ответы на вопросы покупателей

        2. СТРУКТУРА ОПИСАНИЯ (ОБЯЗАТЕЛЬНАЯ ПОСЛЕДОВАТЕЛЬНОСТЬ):

           АБЗАЦ 1: ОСНОВНОЕ НАЗНАЧЕНИЕ И ПРЕИМУЩЕСТВА
           - Что представляет собой товар
           - Основные сферы применения
           - Ключевые преимущества (из параметров)
           - Использовать 2-3 основных ключевых слова

           АБЗАЦ 2: ХАРАКТЕРИСТИКИ И МАТЕРИАЛЫ
           - Детальное описание материалов
           - Технические характеристики
           - Особенности производства/изготовления
           - LSI-слова о материалах и качестве

           АБЗАЦ 3: ПРАКТИЧЕСКОЕ ПРИМЕНЕНИЕ (самый важный абзац)
           - Конкретные примеры использования
           - Подробные сценарии применения
           - Решение каких задач обеспечивает
           - Маркированный список из 4-5 пунктов применения

           АБЗАЦ 4: МОНТАЖ И ЭКСПЛУАТАЦИЯ
           - Особенности установки/монтажа
           - Требования к поверхности/подготовке
           - Уход и обслуживание
           - Рекомендации по эксплуатации

           АБЗАЦ 5: СРАВНИТЕЛЬНЫЕ ПРЕИМУЩЕСТВА
           - Чем отличается от аналогов
           - Уникальные особенности
           - Экономические выгоды (если есть)
           - Долговечность и надежность (факты, не оценки)

           АБЗАЦ 6: ИТОГОВОЕ РЕЗЮМЕ
           - Краткое повторение ключевых преимуществ
           - Универсальность применения
           - Целевая аудитория товара

        3. SEO-СТРАТЕГИЯ ДЛЯ ЭТОГО ТОВАРА:

           ТЕМАТИЧЕСКИЕ КЛАСТЕРЫ (распределить по абзацам):
           1. {clusters[0] if clusters else 'Основное назначение'}
           2. {clusters[1] if len(clusters) > 1 else 'Характеристики и материалы'}
           3. {clusters[2] if len(clusters) > 2 else 'Практическое применение'}
           4. {clusters[3] if len(clusters) > 3 else 'Монтаж и эксплуатация'}

           LSI-СЛОВА ДЛЯ РАСШИРЕНИЯ СЕМАНТИКИ:
           • Основные: {', '.join(lsi_keywords[:8])}
           • Дополнительные: {', '.join(extended_lsi[:8])}

        4. ИСПОЛЬЗОВАНИЕ КЛЮЧЕВЫХ СЛОВ:
           - Основной ключ: 4-6 раз в тексте
           - Второстепенные ключи: 2-3 раза каждый
           - LSI-слова: минимум 1 раз каждое
           - Вариации и синонимы: обязательно использовать
           - Естественное вхождение: не более 2 ключей в предложении

        5. ЗАПРЕЩЕННЫЕ ПРИЕМЫ:
           ❌ Повтор ключевых слов подряд
           ❌ Однотипные предложения
           ❌ Шаблонные фразы и клише
           ❌ Водные слова без смысловой нагрузки
           ❌ Оценочные суждения без фактов

        6. ПРИМЕР СТРУКТУРИРОВАННОГО АБЗАЦА (для абзаца 3):
           "Декоративные панели ПВХ находят применение в различных сценариях отделки:
           • Отделка стен в ванной комнате благодаря влагостойким свойствам материала
           • Создание фартука на кухне с повышенной устойчивостью к загрязнениям
           • Оформление коридоров и прихожих с высокой проходимостью
           • Отделка коммерческих помещений: кафе, офисов, торговых залов
           • Ремонт на даче или в загородном доме с простым монтажом"

        7. ТЕХНИКА ПИРАМИДЫ ОТВЕТОВ:
           - В начале абзаца: главный тезис
           - В середине: детализация и примеры
           - В конце: вывод или переход к следующей теме

        ВЕРНИ ТОЛЬКО готовое описание, без заголовков "Абзац 1", "Абзац 2" и т.д.
        Сделай плавные переходы между абзацами.
        Убедись, что описание отвечает на возможные вопросы покупателей.
        """

        return system_prompt, user_prompt

    def get_ozon_title_prompt(self, category: str, purposes: List[str],
                              additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
        """
        Промпт для генерации SEO-названия Ozon

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if purposes else ""
        params_text = ", ".join(additional_params) if additional_params else "не указаны"
        keywords_text = ", ".join(keywords[:20])  # Берем 20 ключевых слов

        system_prompt = """Ты — профессиональный SEO-специалист для маркетплейса Ozon.
        Твоя задача — создать SEO-оптимизированное название товара по правилам Ozon."""

        user_prompt = f"""
        СОЗДАЙ SEO-НАЗВАНИЕ ДЛЯ OZON

        Контекст:
        - Категория товара: {category}
        - Назначения: {purposes_text}
        - Дополнительные параметры: {params_text}
        - Ключевые слова: {keywords_text}

        ПРАВИЛА СОЗДАНИЯ SEO-НАЗВАНИЯ НА OZON:
        1. НАЗВАНИЕ = ГЛАВНЫЙ ПОИСКОВЫЙ ЗАПРОС
        2. Один товар — один основной запрос
        3. Структура: [Тип товара] + [Ключевая характеристика] + [Назначение/Формат] + [Важные уточнения]
        4. Оптимальная длина: 120–160 символов
        5. Первые 60–70 символов — самые важные (их видно в поиске)

        ЧТО ОБЯЗАТЕЛЬНО ДОЛЖНО БЫТЬ В НАЗВАНИИ:
        ✅ Тип товара (панель ПВХ, обои, фартук и т.д.)
        ✅ Основной ключ (то, как ищут: «стеновая», «самоклеящаяся», «под дерево»)
        ✅ 1–2 сильные характеристики (цвет, размер, влагостойкость, назначение)

        ЧЕГО НЕЛЬЗЯ ДЕЛАТЬ:
        ❌ Переспам ключами (панель пвх стеновая пвх панель)
        ❌ Маркетинговые слова без смысла (лучшая, топ, премиум, супер, хит)
        ❌ КАПСЛОК, смайлы, спецсимволы
        ❌ Повтор информации, которая уже есть в характеристиках

        ПРИМЕРЫ ХОРОШИХ НАЗВАНИЙ:
        - Панель ПВХ стеновая под мрамор белая влагостойкая 2700×250 мм
        - Обои самоклеящиеся 3D под кирпич для кухни 45×250 см
        - Фартук пластиковый для кухни с рисунком 60×90 см

        ПРИМЕРЫ ПЛОХИХ НАЗВАНИЙ:
        - Стильная дизайнерская панель премиум класса для вашего интерьера (нет поисковых слов)
        - Панель ПВХ ПВХ ПВХ стеновая панель (спам)
        - ЛУЧШАЯ ПАНЕЛЬ ДЛЯ ДОМА!!! (капслок, маркетинг)

        ВЕРНИ ТОЛЬКО готовое название, без кавычек, без пояснений.
        """

        return system_prompt, user_prompt

    def get_ozon_desc_prompt(self, category: str, purposes: List[str],
                             additional_params: List[str], keywords: List[str]) -> tuple[str, str]:
        """
        Промпт для генерации SEO-описания Ozon

        Returns:
            Кортеж (system_prompt, user_prompt)
        """
        purposes_text = ", ".join(purposes) if purposes else ""
        params_text = ", ".join(additional_params) if additional_params else "не указаны"
        keywords_text = ", ".join(keywords[:30])  # Берем 30 ключевых слов

        # Формируем основной ключ (первое ключевое слово + назначение)
        main_keyword = keywords[0] if keywords else category
        main_keyword_full = f"{main_keyword} {purposes_text}" if purposes_text else main_keyword

        system_prompt = """Ты — профессиональный SEO-специалист для маркетплейса Ozon.
        Твоя задача — создать SEO-оптимизированное описание товара по правилам Ozon."""

        user_prompt = f"""
        СОЗДАЙ SEO-ОПИСАНИЕ ДЛЯ OZON

        Контекст:
        - Категория товара: {category}
        - Назначения: {purposes_text}
        - Дополнительные параметры: {params_text}
        - Ключевые слова: {keywords_text}
        - Основной ключ: {main_keyword_full}

        ПРАВИЛА СОЗДАНИЯ SEO-ОПИСАНИЯ НА OZON:
        1. ОПИСАНИЕ = УСИЛЕНИЕ РЕЛЕВАНТНОСТИ И КОНВЕРСИИ
        2. Объём: 1500–3000 знаков (оптимально)
        3. Ozon — это не Google: точные формулировки важнее художественного текста

        СТРУКТУРА ЭФФЕКТИВНОГО SEO-ОПИСАНИЯ:
        1. ВВОДНЫЙ АБЗАЦ: первые 2–3 предложения с основным ключом
        2. ПОЛЬЗА И ПРИМЕНЕНИЕ: где и как используется товар
        3. ПРЕИМУЩЕСТВА: маркированный список (обязательно!)
        4. ДОПОЛНИТЕЛЬНЫЕ ФОРМУЛИРОВКИ: LSI-слова и синонимы

        ИСПОЛЬЗОВАНИЕ КЛЮЧЕВЫХ СЛОВ:
        ✅ Основной ключ — 2–3 раза в тексте
        ✅ Дополнительные ключи — 1 раз каждый
        ✅ LSI-слова и синонимы — обязательно
        ❌ ЗАПРЕЩЕН СПАМ: не повторяй ключи много раз

        LSI-СЛОВА ДЛЯ ПРИМЕРА (используй похожие):
        - отделка стен
        - декоративные панели
        - внутренняя отделка
        - ремонт без грязи
        - монтаж своими руками

        ПРИМЕР ХОРОШЕГО ВВОДНОГО АБЗАЦА:
        "Стеновая панель ПВХ под мрамор — практичное решение для отделки стен в ванной, кухне и коридоре. Панели ПВХ отличаются влагостойкостью, простотой ухода и аккуратным внешним видом."

        ПРИМЕР МАРКИРОВАННОГО СПИСКА:
        • Влагостойкая поверхность
        • Подходит для кухни и ванной
        • Легко моется
        • Аккуратная геометрия рисунка
        • Простой монтаж

        ВЕРНИ ТОЛЬКО готовое описание, без заголовков, без пояснений.
        Обязательно включи маркированный список преимуществ!
        """

        return system_prompt, user_prompt

    # def get_title_prompt(self, category_name: str, purpose: str, additional_params: list) -> str:
    #     """Промпт для генерации заголовка"""
    #     prompt = f"""
    #     Создай продающий заголовок для товара на маркетплейсе со следующими параметрами:
    #
    #     Категория: {category_name}
    #     Назначение товара: {purpose}
    #     Дополнительные параметры: {', '.join(additional_params) if additional_params else 'нет'}
    #
    #     Требования к заголовку:
    #     1. Максимально продающий и привлекательный
    #     2. Включает основные преимущества товара
    #     3. Соответствует категории "{category_name}"
    #     4. Оптимизирован для поиска на маркетплейсе
    #     5. Длина от 5 до 10 слов
    #     6. Не используй HTML теги
    #     7. Пиши на русском языке
    #     8. Не используй специальные символы "!, :, ^, )" и т.д.
    #     9. Дополнительные параметры должны привлекательно встраиваться в заголовок. Например: не "Зимняя рубашка для Нового года", а "Новогодняя зимняя рубашка"
    #     10. Ты создаешь заголовок в карточке товара на маркетплейсе
    #     """
    #     return prompt


    def _extract_lsi_keywords(self, keywords: List[str], category: str, purposes: List[str]) -> List[str]:
        """Извлечение LSI-слов из ключевых слов"""
        lsi_words = []

        # Базовые LSI-слова по категории
        base_lsi = {
            "панели": ["отделка стен", "внутренняя отделка", "декоративные элементы", "интерьерные решения",
                       "ремонт", "облицовка", "стеновые покрытия", "отделочные материалы"],
            "обои": ["настенные покрытия", "отделка стен", "декор интерьера", "дизайн помещения",
                     "оклейка стен", "отделочные материалы", "интерьерные решения"],
            "фартуки": ["защита стен", "отделка кухни", "кухонный фартук", "защитное покрытие",
                        "кухонная отделка", "рабочая зона кухни", "защита от брызг"]
        }

        # Добавляем базовые LSI для категории
        for cat, words in base_lsi.items():
            if cat in category.lower():
                lsi_words.extend(words)

        # Извлекаем LSI из ключевых слов
        for keyword in keywords:
            if len(keyword.split()) > 1:  # Фразовые ключи
                # Разбиваем на компоненты для LSI
                words = keyword.split()
                if len(words) >= 2:
                    # Создаем возможные LSI-комбинации
                    for i in range(len(words)):
                        for j in range(i + 1, min(i + 3, len(words))):
                            phrase = ' '.join(words[i:j])
                            if len(phrase) > 3 and phrase not in lsi_words:
                                lsi_words.append(phrase)

        # Добавляем слова из назначений
        for purpose in purposes:
            purpose_lsi = {
                "кухня": ["готовка", "приготовление пищи", "кухонное пространство", "рабочая зона"],
                "ванная": ["ванная комната", "санузел", "помещение с влажностью", "душевая"],
                "спальня": ["комната для сна", "спальное помещение", "личное пространство"],
                "гостиная": ["зал для приема гостей", "общая комната", "семейная комната"],
                "коридор": ["прихожая", "холл", "проходное помещение", "входная зона"]
            }
            for purp, words in purpose_lsi.items():
                if purp in purpose.lower():
                    lsi_words.extend(words)

        return list(set(lsi_words))[:25]  # Ограничиваем 25 уникальными LSI

    def _get_extended_lsi_clusters(self, category: str, purposes: List[str]) -> List[str]:
        """Получение расширенных LSI-кластеров"""
        extended_clusters = []

        # Кластеры по свойствам
        property_clusters = [
            "влагозащита и водостойкость",
            "простота монтажа и установки",
            "уход и очистка поверхности",
            "долговечность и износостойкость",
            "экологичность и безопасность",
            "универсальность применения",
            "стоимость и экономичность"
        ]

        # Кластеры по применению
        application_clusters = [
            "жилые помещения и квартиры",
            "коммерческие объекты и офисы",
            "загородные дома и дачи",
            "ремонт и реконструкция",
            "дизайн интерьера и оформление",
            "строительство и отделка"
        ]

        extended_clusters.extend(property_clusters)
        extended_clusters.extend(application_clusters)

        return extended_clusters[:15]

    def _identify_seo_clusters(self, keywords: List[str], category: str, purposes: List[str]) -> List[str]:
        """Идентификация тематических SEO-кластеров"""
        clusters = []

        # Базовые кластеры по частоте ключей
        keyword_freq = {}
        for keyword in keywords:
            words = keyword.lower().split()
            for word in words:
                if len(word) > 3:  # Игнорируем предлоги и короткие слова
                    keyword_freq[word] = keyword_freq.get(word, 0) + 1

        # Группируем по темам
        material_words = ["пвх", "пластик", "мдф", "дерево", "камень", "металл"]
        property_words = ["влаг", "стойк", "прочн", "износ", "легк", "прост"]
        application_words = ["кухн", "ванн", "спаль", "гости", "корид", "офис", "коммер"]
        size_words = ["размер", "см", "мм", "метр", "ширин", "высот"]

        # Создаем кластеры на основе частот
        clusters.append(f"Материалы и состав: {', '.join([w for w in material_words if w in keyword_freq][:3])}")
        clusters.append(f"Свойства: {', '.join([w for w in property_words if w in keyword_freq][:3])}")
        clusters.append(f"Применение: {', '.join([w for w in application_words if w in keyword_freq][:3])}")
        clusters.append(f"Габариты: {', '.join([w for w in size_words if w in keyword_freq][:2])}")

        return clusters

    def get_system_prompt_for_title(self) -> str:
        """Системный промпт для генерации заголовка"""
        return """
        Ты профессиональный копирайтер для маркетплейсов Wildberries и OZON.
        Создавай продающие, естественные заголовки для товаров.
        """

    def get_keywords_prompt(self, title: str, category_name: str) -> str:
        """Промпт для генерации ключевых слов"""
        prompt = f"""
        Извлеки 8-12 ключевых слов из этого заголовка для маркетплейса:

        Заголовок: {title}
        Категория: {category_name}

        Требования к ключевым словам:
        1. Релевантные товару
        2. Популярные для поиска на маркетплейсах
        3. Без стоп-слов
        4. В именительном падеже
        5. Разделяй запятыми

        Верни только список ключевых слов через запятую.
        """
        return prompt

    def get_description_prompt(self, title: str, keywords: list, description_type: str, category: str) -> str:
        """Промпт для генерации описания"""
        type_info = {
            "short": {"length": "краткое", "max_words": "50-100 слов"},
            "long": {"length": "подробное", "max_words": "150-300 слов"}
        }
        info = type_info.get(description_type, {"length": "описание", "max_words": "100-200 слов"})

        prompt = f"""
        Создай {info['length']} описание для товара на маркетплейсе.

        Заголовок товара: {title}
        Ключевые слова: {', '.join(keywords)}
        Категория: {category}

        Требования к описанию:
        1. Продающее и информативное
        2. Естественно включай ключевые слова
        3. Структурированный текст (для длинного описания - с абзацами)
        4. Без эмодзи и HTML тегов
        5. Длина: {info['max_words']}
        6. Пиши на русском языке
        7. Оптимизировано под поиск на маркетплейсе
        """
        return prompt

    def get_system_prompt_for_description(self) -> str:
        """Системный промпт для генерации описания"""
        return """
        Ты профессиональный копирайтер для маркетплейсов.
        Создавай продающие, информативные описания товаров.
        """